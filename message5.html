<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶²è·¯é˜²ç¦¦ï¼šè³‡å®‰å¤§æŒ‘æˆ°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        /* åŸºç¤æ¨£å¼ï¼šç‡Ÿé€ çµ‚ç«¯æ©Ÿé¢¨æ ¼ */
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #0d1117; 
            color: #00ff41; 
            font-family: 'VT323', monospace;
            overflow: hidden;
            padding: 10px;
        }

        /* ä¸»å®¹å™¨ */
        .game-container {
            border: 3px solid #00ff41;
            box-shadow: 0 0 20px #00ff41, inset 0 0 10px #00ff4180;
            background-color: #000000;
            position: relative;
            max-width: 95vw;
            width: 900px;
            height: 500px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        /* é ‚éƒ¨è³‡è¨Šæ¬„ */
        .info-bar {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            font-size: 1.5rem;
            border-bottom: 1px solid #00ff4150;
            margin-bottom: 5px;
        }

        /* ç•«å¸ƒå’Œä»‹é¢å±¤ç–Š */
        .game-area {
            position: relative;
            width: 100%;
            flex-grow: 1; /* è®“ Canvas å€åŸŸä½”æ»¿å‰©é¤˜ç©ºé–“ */
        }

        #gameCanvas {
            display: block;
            background: linear-gradient(to bottom, #000000, #1a1a1a);
            border-radius: 4px;
            cursor: crosshair;
        }

        /* éŠæˆ²ä»‹é¢ Overlay æ¨£å¼ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            color: #00ff41;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 2rem;
            border-radius: 4px;
            z-index: 20;
        }

        .overlay h1 {
            font-size: 3rem;
            text-shadow: 0 0 10px #00ff41;
            margin-bottom: 10px;
        }

        .overlay p {
            margin: 15px 0;
            font-size: 1.5rem;
        }
        
        .button-group button {
            background-color: #00ff41;
            color: #000000;
            border: none;
            padding: 10px 20px;
            font-family: 'VT323', monospace;
            font-size: 1.6rem;
            cursor: pointer;
            border-radius: 4px;
            margin: 10px;
            transition: all 0.1s ease-in-out;
            box-shadow: 0 0 8px #00ff41;
        }

        .button-group button:hover {
            background-color: #00cc33;
            box-shadow: 0 0 12px #00ff41, 0 0 5px #00cc33;
        }
        
        /* é€€å‡ºæŒ‰éˆ•ç‰¹æ®Šæ¨£å¼ */
        .button-group button.exit-button {
            background-color: #ff3333;
            color: #ffffff;
            box-shadow: 0 0 8px #ff3333;
        }

        .button-group button.exit-button:hover {
            background-color: #cc0000;
            box-shadow: 0 0 12px #ff3333, 0 0 5px #cc0000;
        }

        /* æ–°å¢ï¼šè‡¨æ™‚è¨Šæ¯æ¡†æ¨£å¼ */
        .message-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #00ff41;
            color: #000000;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 1.2rem;
            box-shadow: 0 0 15px #00ff41;
            opacity: 0;
            transition: opacity 0.5s ease-out;
            z-index: 30;
        }
    </style>
</head>
<body>

    <div class="game-container">
        <div class="info-bar">
            <span>æŒ‘æˆ°ç´šåˆ¥: <span id="levelDisplay">åˆå§‹åŒ–...</span></span>
            <span>å¥åº·å€¼ (Server HP): <span id="healthDisplay">250</span></span>
            <span>é˜²ç¦¦åˆ†æ•¸: <span id="scoreDisplay">0</span></span>
        </div>
        
        <div class="game-area">
            <!-- éŠæˆ²é–‹å§‹/èœå–®ç•«é¢ -->
            <div id="startOverlay" class="overlay">
                <h1>ç¶²è·¯é˜²ç¦¦ï¼šè³‡å®‰å¤§æŒ‘æˆ°</h1>
                <p>ä»»å‹™ç›®æ¨™: åˆ©ç”¨è³‡å®‰å·¥å…·ä¿è­·ä¼ºæœå™¨ä¸è¢«æƒ¡æ„å°åŒ…æ”»é™·ã€‚</p>
                <p>é»æ“Šè¢å¹•éƒ¨ç½²é˜²ç¦¦!</p>
                <div class="button-group">
                    <button id="startButton">å•Ÿå‹•é˜²ç¦¦ (START)</button>
                </div>
            </div>

            <!-- é—œå¡çµæŸç•«é¢ -->
            <div id="levelEndOverlay" class="overlay" style="display: none;">
                <h1>é—œå¡ <span id="currentLevelEnd"></span> é˜²ç¦¦æˆåŠŸ!</h1>
                <p>å¨è„…ç­‰ç´šè§£é™¤ã€‚å¾—åˆ†: <span id="levelScoreDisplay">0</span></p>
                <div class="button-group">
                    <button id="continueButton">ç¹¼çºŒéŠæˆ² (NEXT LEVEL)</button>
                    <button id="exitButton" class="exit-button">é€€å‡ºç³»çµ± (EXIT)</button>
                </div>
            </div>

            <!-- éŠæˆ²çµæŸç•«é¢ -->
            <div id="gameOverOverlay" class="overlay" style="display: none;">
                <h1>ç³»çµ±å´©æ½° (SYSTEM BREACH)</h1>
                <p>æ‰€æœ‰ä¼ºæœå™¨è¢«æ”»é™·ã€‚æœ€çµ‚å¾—åˆ†: <span id="finalScoreDisplay">0</span></p>
                <div class="button-group">
                    <button id="restartGameButton">é‡æ–°å•Ÿå‹• (REBOOT)</button>
                    <button id="finalExitButton" class="exit-button">é€€å‡ºç³»çµ± (EXIT)</button>
                </div>
            </div>

            <canvas id="gameCanvas"></canvas>
            
            <!-- è¨Šæ¯æç¤ºæ¡† -->
            <div id="messageBox" class="message-box" style="display: none;"></div>
        </div>
    </div>

    <script>
        // === å…¨å±€è®Šæ•¸åŠåˆå§‹åŒ– ===
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const info = {
            level: document.getElementById('levelDisplay'),
            health: document.getElementById('healthDisplay'),
            score: document.getElementById('scoreDisplay'),
            start: document.getElementById('startOverlay'),
            levelEnd: document.getElementById('levelEndOverlay'),
            gameOver: document.getElementById('gameOverOverlay'),
            currentLevelEnd: document.getElementById('currentLevelEnd'),
            levelScore: document.getElementById('levelScoreDisplay'),
            finalScore: document.getElementById('finalScoreDisplay'),
            startButton: document.getElementById('startButton'),
            continueButton: document.getElementById('continueButton'),
            exitButton: document.getElementById('exitButton'),
            restartGameButton: document.getElementById('restartGameButton'),
            finalExitButton: document.getElementById('finalExitButton'),
            messageBox: document.getElementById('messageBox') // æ–°å¢è¨Šæ¯æ¡†å¼•ç”¨
        };

        // éŠæˆ²ç‹€æ…‹æ©Ÿ
        let gameState = 'MENU'; // MENU, LEVEL_1, LEVEL_2, LEVEL_3, LEVEL_END, GAME_OVER
        let currentLevel = 0;
        let score = 0;
        let health = 250;
        let enemies = [];
        let defenses = [];
        let gameFrame = 0;
        let enemyTimer = 0;
        let levelDuration = 0;
        let gameRunning = false;
        
        // ä¼ºæœå™¨æ ¸å¿ƒä½ç½® (ç›®æ¨™)
        const core = {
            x: 50,
            y: canvas.height / 2,
            radius: 20
        };
        
        // å¨è„…å’Œé˜²ç¦¦é…ç½®
        const CONFIG = {
            // æ‰€æœ‰å¨è„…éƒ½æœƒå˜—è©¦åˆ°é” CORE
            CORE_X: 50,
            
            // é—œå¡é…ç½®
            LEVELS: [
                { 
                    name: 'ç¶²è·¯é‡£é­šé˜²ç¦¦', 
                    duration: 1500, // å¹€æ•¸
                    speed: 1.5,
                    healthCost: 5,
                    enemyType: 'PHISHING_EMAIL',
                    defenseType: 'SPAM_FILTER', // é»æ“Šå‹é˜²ç¦¦ (é»æ“Šå¨è„…)
                    spawnRate: 90 // å¹€æ•¸é–“éš”
                },
                { 
                    name: 'DDoS æµé‡ç®¡åˆ¶', 
                    duration: 2000, 
                    speed: 3.5, // æ›´å¿«
                    healthCost: 1, // å‚·å®³ä½ä½†æ•¸é‡å¤š
                    enemyType: 'BOT_PACKET',
                    defenseType: 'FIREWALL_RULE', // æ”¾ç½®å‹é˜²ç¦¦ (é»æ“Šç•«å¸ƒä¸€æ¬¡)
                    spawnRate: 30
                },
                { 
                    name: 'é›¶æ™‚å·®æ”»æ“Šé˜»æ–·', 
                    duration: 1800, 
                    speed: 1.2, // ç•¥ç‚ºå¢åŠ é€Ÿåº¦
                    healthCost: 20,
                    enemyType: 'ZERO_DAY',
                    defenseType: 'ENDPOINT_DETECTION', // é»æ“Šå‹é˜²ç¦¦ (é»æ“Šå¨è„…)
                    spawnRate: 450 // æ¸›å°‘ç”Ÿæˆæ•¸é‡ (åŸ300)
                },
                { 
                    name: 'æƒ¡æ„è»Ÿé«”æ„ŸæŸ“é˜²ç¦¦', 
                    duration: 2000, 
                    speed: 1.0, // é™ä½é€Ÿåº¦
                    healthCost: 10,
                    enemyType: 'MALWARE',
                    defenseType: 'ANTIVIRUS_SCAN', // é»æ“Šå‹é˜²ç¦¦ (é»æ“Šå¨è„…)
                    spawnRate: 60
                },
                { 
                    name: 'é€²éšç—…æ¯’é™·é˜±é˜»æ–·', 
                    duration: 2500, 
                    speed: 2.0, // é™ä½é€Ÿåº¦
                    healthCost: 15,
                    enemyType: 'ADVANCED_THREAT',
                    defenseType: 'FIREWALL_RULE', // æ”¾ç½®å‹é˜²ç¦¦ï¼Œåƒç¬¬2é—œ
                    spawnRate: 45
                }
            ]
        };

        // === ç¹ªè£½å‡½æ•¸ (Draw Functions) ===

        // ç¹ªè£½ä¼ºæœå™¨æ ¸å¿ƒ
        function drawCore() {
            ctx.beginPath();
            ctx.arc(core.x, core.y, core.radius, 0, Math.PI * 2);
            ctx.fillStyle = health > 75 ? '#00ccff' : '#ff0000'; // è—è‰²æ­£å¸¸ï¼Œç´…è‰²è­¦å‘Š
            ctx.shadowColor = ctx.fillStyle;
            ctx.shadowBlur = 10;
            ctx.fill();
            ctx.shadowBlur = 0; // é‡ç½®é™°å½±

            ctx.fillStyle = '#000000';
            ctx.font = '12px VT323';
            ctx.textAlign = 'center';
            ctx.fillText('SERVER', core.x, core.y + 4);
        }

        // ç¹ªè£½å¨è„…
        function drawEnemy(enemy) {
            ctx.fillStyle = enemy.color;
            ctx.shadowColor = enemy.color;
            ctx.shadowBlur = 5;
            ctx.font = '16px VT323';

            switch (enemy.type) {
                case 'PHISHING_EMAIL':
                    // ç¹ªè£½ä¿¡å°æˆ–é‡£é­šç¬¦è™Ÿ (Email/Phishing)
                    ctx.fillText('ğŸ“§', enemy.x - 8, enemy.y + 5);
                    break;
                case 'BOT_PACKET':
                    // ç¹ªè£½å°å‹æ–¹å¡Š (DDoS Bot)
                    ctx.fillRect(enemy.x - 5, enemy.y - 5, 10, 10);
                    break;
                case 'ZERO_DAY':
                    // ç¹ªè£½Xå‹æˆ–å±éšªç¬¦è™Ÿ
                    ctx.fillText('â˜¢ï¸', enemy.x - 8, enemy.y + 5);
                    break;
                case 'MALWARE':
                case 'ADVANCED_THREAT':
                    // ç¹ªè£½æƒ¡æ„è»Ÿé«”ç¬¦è™Ÿ
                    ctx.fillText('ğŸ’»', enemy.x - 8, enemy.y + 5);
                    break;
                case 'VIRUS_TRAP':
                    // ç¹ªè£½ç—…æ¯’é™·é˜±ç¬¦è™Ÿ (ä¸åŒä»¥å€åˆ†)
                    ctx.fillText('ğŸ¦ ', enemy.x - 8, enemy.y + 5);
                    break;
            }
            ctx.shadowBlur = 0;
        }

        // ç¹ªè£½é˜²ç¦¦
        function drawDefense(defense) {
            ctx.fillStyle = defense.color;
            ctx.shadowColor = defense.color;
            ctx.shadowBlur = 8;
            ctx.font = '18px VT323';
            
            switch (defense.type) {
                case 'SPAM_FILTER':
                case 'ENDPOINT_DETECTION':
                case 'ANTIVIRUS_SCAN':
                case 'INTRUSION_PREVENTION':
                    // é»æ“Šå¾Œæ¶ˆå¤±ï¼Œä¸éœ€è¦æŒçºŒç¹ªè£½
                    break;
                case 'FIREWALL_RULE':
                    // ç¹ªè£½çŸ©å½¢é˜²ç«ç‰†å±éšœ
                    ctx.fillRect(defense.x, defense.y, defense.width, defense.height);
                    ctx.fillStyle = '#000000';
                    ctx.fillText('FW', defense.x + 5, defense.y + defense.height / 2 + 5);
                    break;
            }
            ctx.shadowBlur = 0;
        }
        
        // ç¹ªè£½äºŒé€²ä½èƒŒæ™¯ (éœæ…‹/å¾®å‹•æ…‹)
        function drawBackground() {
            ctx.fillStyle = 'rgba(0, 255, 65, 0.05)';
            ctx.font = '12px VT323';

            // ç°¡å–®æ¨¡æ“¬æ•¸æ“šæµ
            for (let i = 0; i < canvas.width / 20; i++) {
                for (let j = 0; j < canvas.height / 20; j++) {
                    const char = (i + j + Math.floor(gameFrame / 10)) % 2 === 0 ? '1' : '0';
                    ctx.fillText(char, i * 20 + 5, j * 20 + 10);
                }
            }
        }

        // === é‚è¼¯å‡½æ•¸ (Logic Functions) ===

        // é¡¯ç¤ºè‡¨æ™‚è¨Šæ¯æ¡†
        function showMessage(text) {
            const box = info.messageBox;
            box.textContent = text;
            box.style.display = 'block';
            // ç¢ºä¿ opacity å¾ 0 é–‹å§‹è®ŠåŒ–
            requestAnimationFrame(() => {
                box.style.opacity = '1';
            });

            // 3 ç§’å¾Œæ·¡å‡ºä¸¦éš±è—
            setTimeout(() => {
                box.style.opacity = '0';
                setTimeout(() => {
                    box.style.display = 'none';
                }, 500); // ç­‰å¾…éæ¸¡å®Œæˆ
            }, 3000);
        }

        function resizeCanvas() {
            const container = canvas.closest('.game-area');
            if (container) {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                core.y = canvas.height / 2;
                // é‡ç½®é˜²ç¦¦ä½ç½®ä»¥é©æ‡‰æ–°å°ºå¯¸ (ç‰¹åˆ¥æ˜¯ FIREWALL_RULE)
                defenses = defenses.map(d => {
                    if (d.type === 'FIREWALL_RULE') {
                        d.x = canvas.width / 2;
                        d.y = 0;
                        d.height = canvas.height;
                    }
                    return d;
                });
            }
        }
        
        function updateUI() {
            info.level.textContent = `LEVEL ${currentLevel} (${CONFIG.LEVELS[currentLevel - 1]?.name || 'N/A'})`;
            info.health.textContent = health;
            info.score.textContent = score;
            
            // æ ¹æ“šç”Ÿå‘½å€¼æ”¹è®Šé¡è‰²
            if (health < 75) {
                info.health.style.color = '#ff3333';
            } else if (health < 150) {
                info.health.style.color = '#ffcc00';
            } else {
                info.health.style.color = '#00ff41';
            }
        }

        function resetGame() {
            currentLevel = 0;
            score = 0;
            health = 250;
            gameFrame = 0;
            enemies = [];
            defenses = [];
        }

        function startGame() {
            resetGame();
            gameRunning = true; 
            goToNextLevel();
        }

        function goToNextLevel() {
            currentLevel++;
            enemies = [];
            defenses = [];
            gameFrame = 0;

            if (currentLevel > CONFIG.LEVELS.length) {
                // éŠæˆ²å‹åˆ©
                showLevelEndScreen();
                info.currentLevelEnd.textContent = `5 / æœ€çµ‚`;
                info.levelScore.textContent = score;
                info.continueButton.style.display = 'none'; 
                info.levelEnd.querySelector('h1').textContent = "æœ€çµ‚æŒ‘æˆ° é˜²ç¦¦æˆåŠŸï¼";
                return;
            }

            gameState = `LEVEL_${currentLevel}`;
            gameRunning = true; 
            updateUI();
            hideAllOverlays();
            
            // é—œå¡ç‰¹å®šæç¤º
            if (currentLevel === 2 || currentLevel === 5) {
                showMessage("L" + currentLevel + " å•Ÿå‹•: é»æ“Šç•«å¸ƒ'ä¸€æ¬¡'éƒ¨ç½²é˜²ç«ç‰† (Firewall)ã€‚é˜²ç«ç‰†æœ‰è¡€é‡é™åˆ¶!");
            } else if (currentLevel >= 4) {
                showMessage("L" + currentLevel + " å•Ÿå‹•: é»æ“Šæƒ¡æ„å¨è„…å°‡å…¶éŠ·æ¯€! ä½†å°å¿ƒç—…æ¯’é™·é˜±(ğŸ¦ )ï¼Œé»æ“Šæœƒæ‰£è¡€!");
            } else {
                showMessage("L" + currentLevel + " å•Ÿå‹•: é»æ“Šæƒ¡æ„å¨è„…å°‡å…¶éŠ·æ¯€!");
            }

            // å•Ÿå‹•éŠæˆ²å¾ªç’°
            gameLoop();
        }

        function showLevelEndScreen() {
            gameState = 'LEVEL_END';
            gameRunning = false; 
            info.currentLevelEnd.textContent = currentLevel;
            info.levelScore.textContent = score;
            info.continueButton.style.display = (currentLevel < CONFIG.LEVELS.length) ? 'inline-block' : 'none'; 
            info.levelEnd.style.display = 'flex';
        }

        function gameOver(win = false) {
            gameState = 'GAME_OVER';
            gameRunning = false; 
            hideAllOverlays();
            info.finalScore.textContent = score;
            info.gameOver.style.display = 'flex';
            info.gameOver.querySelector('h1').textContent = "ç³»çµ±å´©æ½° (SYSTEM BREACH)";
            info.gameOver.querySelector('p').textContent = `æ‰€æœ‰ä¼ºæœå™¨è¢«æ”»é™·ã€‚æœ€çµ‚å¾—åˆ†: ${score}`;
        }
        
        function hideAllOverlays() {
            info.start.style.display = 'none';
            info.levelEnd.style.display = 'none';
            info.gameOver.style.display = 'none';
        }

        // ç”Ÿæˆæ•µäºº
        function spawnEnemy() {
            const currentConfig = CONFIG.LEVELS[currentLevel - 1];
            if (!currentConfig) return;

            let enemyType = currentConfig.enemyType;
            let color = (currentLevel === 3 ? '#ff0000' : (currentConfig.enemyType === 'ZERO_DAY' ? '#ff3333' : '#ffcc00'));
            let healthCost = currentConfig.healthCost;

            // ç¬¬4ã€5é—œéš¨æ©Ÿç”Ÿæˆç—…æ¯’é™·é˜± (30%æ©Ÿç‡)
            if (currentLevel >= 4 && Math.random() < 0.3) {
                enemyType = 'VIRUS_TRAP';
                color = '#ff00ff'; // ç´«è‰²ä»¥å€åˆ†
                healthCost = (currentLevel === 4 ? 0 : 15); // ç¬¬4é—œä¸é»æ“Šä¸æ‰£è¡€ï¼Œåˆ°é”æ ¸å¿ƒä¹Ÿä¸æ‰£
            }

            const enemy = {
                x: canvas.width,
                y: Math.random() * (canvas.height - 40) + 20,
                type: enemyType,
                speed: currentConfig.speed,
                healthCost: healthCost,
                isAlive: true,
                color: color,
                width: 20, // ç°¡æ˜“ç¢°æ’ç”¨
                height: 20  // ç°¡æ˜“ç¢°æ’ç”¨
            };
            enemies.push(enemy);
        }

        // æ›´æ–°æ•µäººç‹€æ…‹
        function updateEnemies() {
            const currentConfig = CONFIG.LEVELS[currentLevel - 1];

            // æª¢æŸ¥æ˜¯å¦é”åˆ°æ™‚é–“é™åˆ¶
            if (gameFrame > currentConfig.duration) {
                showLevelEndScreen();
                return;
            }

            // ç”Ÿæˆæ–°çš„æ•µäºº
            if (gameFrame % currentConfig.spawnRate === 0) {
                spawnEnemy();
            }

            // ç§»å‹•æ•µäººä¸¦æª¢æŸ¥æ ¸å¿ƒç¢°æ’
            enemies.forEach(enemy => {
                if (!enemy.isAlive) return;
                
                // æœè‘— CORE_X ç§»å‹•
                enemy.x -= enemy.speed;

                // æ ¸å¿ƒç¢°æ’æª¢æ¸¬
                if (enemy.x <= core.x + core.radius) {
                    health -= enemy.healthCost;
                    enemy.isAlive = false; // ç§»é™¤å·²é€ æˆå‚·å®³çš„æ•µäºº
                    if (health <= 0) {
                        gameOver();
                    }
                }
            });

            enemies = enemies.filter(e => e.isAlive && e.x > 0);
        }

        // è™•ç†ç©å®¶é»æ“Šé˜²ç¦¦
        function deployDefense(e) {
            if (!gameRunning) return; 

            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;

            const currentConfig = CONFIG.LEVELS[currentLevel - 1];
            
            if (currentConfig.defenseType !== 'FIREWALL_RULE') {
                // é»æ“Šå‹é˜²ç¦¦: å˜—è©¦éŠ·æ¯€é»æ“Šä½ç½®é™„è¿‘çš„æ•µäºº
                let enemiesDestroyed = 0;
                enemies.forEach(enemy => {
                    // æª¢æŸ¥æ˜¯å¦åœ¨é»æ“Šç¯„åœå…§ (20px)
                    if (Math.abs(enemy.x - clickX) < 20 && Math.abs(enemy.y - clickY) < 20) {
                        if (enemy.type === 'VIRUS_TRAP') {
                            // é»æ“Šç—…æ¯’é™·é˜±: æ‰£è¡€ä½†éŠ·æ¯€
                            health -= 10;
                            if (health <= 0) {
                                gameOver();
                            }
                            showMessage("è­¦å‘Š! é»æ“Šç—…æ¯’é™·é˜±é€ æˆæå®³!");
                            enemy.isAlive = false;
                            score += 5; // å°‘é‡åŠ åˆ†
                        } else {
                            enemy.isAlive = false;
                            score += 10; // æ­£å¸¸åŠ åˆ†
                        }
                        enemiesDestroyed++;
                    }
                });
                
                // é»æ“Šå¾Œé¡¯ç¤ºä¸€å€‹çŸ­æš«çš„é˜²ç¦¦æ•ˆæœ
                if (enemiesDestroyed > 0) {
                    // æ¨¡æ“¬é˜²ç¦¦æ•ˆæœï¼Œä¾‹å¦‚ä¸€å€‹ç¶ è‰²é–ƒå…‰
                    const flash = { x: clickX, y: clickY, radius: 0, maxRadius: 50, life: 30, color: '#00ff41' };
                    defenses.push(flash);
                } else {
                     // é»æ“Šè½ç©ºï¼Œçµ¦äºˆæç¤º
                     const missFlash = { x: clickX, y: clickY, radius: 0, maxRadius: 20, life: 15, color: '#ffcc00' };
                     defenses.push(missFlash);
                }

            } else if (currentConfig.defenseType === 'FIREWALL_RULE') {
                // æ”¾ç½®å‹é˜²ç¦¦ (Level 2 & 5: DDoS) - åªå…è¨±æ”¾ç½®ä¸€æ¬¡
                if (defenses.length === 0) {
                    const firewall = {
                        type: 'FIREWALL_RULE',
                        x: canvas.width / 2, // å›ºå®šåœ¨ä¸­é–“
                        y: 0,
                        width: 15,
                        height: canvas.height,
                        color: '#0066ff', // è—è‰²é˜²ç«ç‰†
                        hp: (currentLevel === 5 ? 200 : Infinity) // ç¬¬5é—œæé«˜è¡€é‡
                    };
                    defenses.push(firewall);
                    showMessage("é˜²ç«ç‰†éƒ¨ç½²æˆåŠŸï¼");
                } else {
                    showMessage("é˜²ç«ç‰†å·²éƒ¨ç½²ï¼Œç„¡éœ€é‡è¤‡æ“ä½œï¼");
                }
            }
        }
        
        // æ›´æ–°é˜²ç¦¦ç‹€æ…‹ (ä¸»è¦ç”¨æ–¼æ”¾ç½®å‹é˜²ç¦¦æˆ–é»æ“Šé–ƒå…‰)
        function updateDefenses() {
            // Firewall é˜²ç¦¦é‚è¼¯
            let firewallIndex = defenses.findIndex(d => d.type === 'FIREWALL_RULE');
            if (firewallIndex !== -1) {
                const firewall = defenses[firewallIndex];
                enemies.forEach(enemy => {
                    if (enemy.isAlive && enemy.x <= firewall.x + firewall.width && enemy.x >= firewall.x) {
                        // æ•µäººç¢°åˆ°é˜²ç«ç‰†
                        if (firewall.hp > 0) {
                            // æ‰£é™¤é˜²ç«ç‰†è¡€é‡
                            firewall.hp -= enemy.healthCost;
                            enemy.isAlive = false;
                            score += 5; // æˆåŠŸé˜²ç¦¦åŠ åˆ†
                            if (firewall.hp <= 0) {
                                // é˜²ç«ç‰†æ¯€æï¼Œç§»é™¤
                                defenses.splice(firewallIndex, 1);
                                showMessage("é˜²ç«ç‰†å·²æ¯€æï¼");
                            }
                        } else {
                            // å¦‚æœé˜²ç«ç‰†å·²æ¯€ï¼Œæ•µäººç¹¼çºŒå‰é€²
                        }
                    }
                });
            }

            // è™•ç†é»æ“Šé–ƒå…‰æ•ˆæœçš„ç”Ÿå‘½é€±æœŸ
            defenses = defenses.filter(d => {
                if (d.life && d.type !== 'FIREWALL_RULE') {
                    d.life--;
                    d.radius += 2;
                    return d.life > 0;
                }
                return true; // ä¿ç•™éé–ƒå…‰å‹çš„é˜²ç¦¦
            });
        }
        
        // éŠæˆ²ä¸»å¾ªç’°
        function gameLoop() {
            if (gameState === 'MENU' || gameState === 'LEVEL_END' || gameState === 'GAME_OVER' || !gameRunning) return;

            // 1. æ¸…é™¤ç•«é¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 2. ç¹ªè£½èƒŒæ™¯å’Œæ ¸å¿ƒ
            drawBackground();
            drawCore();
            
            // 3. æ›´æ–°é‚è¼¯
            gameFrame++;
            updateEnemies();
            updateDefenses();

            // 4. ç¹ªè£½
            defenses.forEach(d => {
                if (d.life && d.type !== 'FIREWALL_RULE') {
                     // ç¹ªè£½é–ƒå…‰æ•ˆæœ
                    ctx.beginPath();
                    ctx.arc(d.x, d.y, d.radius, 0, Math.PI * 2);
                    // æ ¹æ“šé¡è‰²åƒæ•¸ç¹ªè£½é–ƒå…‰
                    ctx.fillStyle = d.color.startsWith('#') ? `${d.color}50` : d.color; // ä½¿ç”¨åŠé€æ˜é¡è‰²
                    ctx.fill();
                } else {
                    drawDefense(d);
                }
            });
            enemies.forEach(drawEnemy);

            // 5. æ›´æ–°è³‡è¨Šæ¬„
            updateUI();

            // 6. å¾ªç’°
            requestAnimationFrame(gameLoop);
        }

        // === äº‹ä»¶ç›£è½å™¨åŠå•Ÿå‹• ===

        function setupListeners() {
            info.startButton.addEventListener('click', startGame);
            info.continueButton.addEventListener('click', goToNextLevel);
            info.restartGameButton.addEventListener('click', startGame);
            
            // é€€å‡ºæŒ‰éˆ•åŠŸèƒ½ï¼šåœ¨ iframe ç’°å¢ƒä¸‹é€šå¸¸ç„¡æ³•ç›´æ¥é—œé–‰çª—å£ï¼Œé€™è£¡æˆ‘å€‘é‡ç½®åˆ°èœå–®ç•«é¢
            const exitAction = () => {
                gameState = 'MENU';
                gameRunning = false; 
                hideAllOverlays();
                info.start.style.display = 'flex';
            };
            info.exitButton.addEventListener('click', exitAction);
            info.finalExitButton.addEventListener('click', exitAction);
            
            // é»æ“Šéƒ¨ç½²é˜²ç¦¦
            canvas.addEventListener('click', deployDefense);
            
            // è¦–çª—å¤§å°æ”¹è®Š
            window.addEventListener('resize', resizeCanvas);
        }

        // åˆå§‹è¨­ç½®
        window.onload = () => {
            setupListeners();
            resizeCanvas();
            // åˆå§‹ç‹€æ…‹ç‚º MENUï¼Œåªé¡¯ç¤ºé–‹å§‹ç•«é¢
            info.start.style.display = 'flex';
        };

    </script>
</body>
</html>